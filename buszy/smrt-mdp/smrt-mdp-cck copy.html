<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>CCK Interchange | SMRT Buses</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    html {
        box-sizing: border-box;
        font-size: 16px;
    }
    *, *:before, *:after {
        box-sizing: inherit;
    }
    body {
        font-family: system-ui, Avenir, Arial, sans-serif;
        margin: 0;
        background: #fff;
        color: #000;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 2vw;
        gap: 1vw;
        flex-wrap: wrap;
    }

    .logo img {
        height: clamp(40px, 8vw, 90px);
        margin-right: 1vw;
        max-width: 100%;
        height: auto;
    }

    .title {
        font-size: clamp(1.2rem, 5vw, 60px);
        font-weight: bold;
        color: #e60012;
        text-align: center;
        flex: 1;
        min-width: 0;
        word-break: break-word;
    }

    .clock {
        text-align: center;
        font-weight: normal;
        min-width: 90px;
    }

    .clock-time {
        font-size: clamp(1.2rem, 6vw, 80px);
        color: #e60012;
        font-weight: normal;
        line-height: 1.1;
    }

    .clock-date {
        font-size: clamp(0.8rem, 2vw, 30px);
        color: #e60012;
    }

    .table-responsive {
        width: 100%;
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.5em;
        font-size: 2rem;
        background: #fff;
    }

    th, td {
        padding-top: 0.1em;
        padding-bottom: 0.3em;
        text-align: center;
        font-size: clamp(1rem, 4vw, 50px);
        word-break: break-word;
    }

    th {
        font-size: clamp(1rem, 2vw, 1.2rem);
        font-weight: 500;
        background: #fff;
        color: #e60012;
    }

    thead .redbar-head th {
        background: #e60012;
        color: #fff;
        font-size: clamp(1.2rem, 3vw, 35px);
        font-weight: 500;
        padding: 0.5em 0.5em;
        border: none;
        text-align: center;
    }

    tr {
        border-bottom: 1px solid #000;
    }

    td:first-child {
        font-weight: bold;
        font-size: clamp(1.1rem, 4.5vw, 55px);
        text-align: center;
    }

    tbody tr:last-child {
        border-bottom: none;
    }

    .bus-icon {
        font-size: 1.7rem;
        color: #2e8b57;
        vertical-align: middle;
    }

    .col-service {
        width: 7vw;
        min-width: 50px;
        max-width: 100px;
    }

    .col-berth {
        width: 10vw;
        min-width: 50px;
        max-width: 120px;
    }

    .col-departure1,
    .col-departure2 {
        width: 18vw;
        min-width: 80px;
        max-width: 220px;
    }

    .ticker-wrap {
        width: 100vw;
        overflow: hidden;
        background: #000;
        position: fixed;
        left: 0;
        bottom: 0;
        z-index: 100;
        height: clamp(24px, 6vw, 60px);
        display: flex;
        align-items: center;
    }

    .ticker {
        display: inline-block;
        white-space: nowrap;
        padding-left: 100%;
        padding-top: 0.5em;
        padding-bottom: 0.5em;
        animation: ticker-scroll 25s linear infinite;
        font-size: clamp(0.8rem, 2.5vw, 35px);
        color: #fff;
        font-weight: 500;
        line-height: 1.2;
        background-color: #000;
    }

    .bustype-icon {
        margin-left: clamp(8px, 3vw, 50px);
        vertical-align: middle;
        width: clamp(28px, 8vw, 80px) !important;
        max-width: 80px;
        height: auto;
    }

    .time-icon-wrap {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 100%;
    }

    .time-icon-wrap span {
        min-width: clamp(30px, 8vw, 115px);
        text-align: left;
        display: inline-block;
    }

    @keyframes ticker-scroll {
        0% { transform: translateX(0%); }
        100% { transform: translateX(-100%); }
    }

    /* Responsive breakpoints */
    @media (max-width: 900px) {
        .header {
            flex-direction: column;
            align-items: center;
            padding: 10px 2vw 0 2vw;
        }
        .logo img {
            height: clamp(30px, 10vw, 50px);
            margin-bottom: 10px;
        }
        .title {
            font-size: clamp(1.1rem, 5vw, 2.2rem);
            margin-bottom: 10px;
        }
        .clock-time {
            font-size: clamp(1rem, 6vw, 2.2rem);
        }
        .clock-date {
            font-size: clamp(0.7rem, 2vw, 1.1rem);
        }
        th, td {
            font-size: clamp(0.9rem, 3vw, 1.1rem);
        }
        td:first-child {
            font-size: clamp(1rem, 4vw, 1.3rem);
        }
        .bustype-icon {
            width: clamp(16px, 6vw, 40px) !important;
            margin-left: 16px;
        }
        .ticker {
            font-size: clamp(0.7rem, 2vw, 1rem);
            line-height: 2.2rem;
        }
        .ticker-wrap {
            height: clamp(18px, 5vw, 36px);
        }
        .time-icon-wrap span {
            min-width: clamp(20px, 6vw, 50px);
        }
    }

    @media (max-width: 600px) {
        .header {
            padding: 5px 2vw 0 2vw;
        }
        .title {
            font-size: clamp(0.9rem, 5vw, 1.2rem);
        }
        .clock-time {
            font-size: clamp(0.8rem, 6vw, 1.2rem);
        }
        .clock-date {
            font-size: clamp(0.6rem, 2vw, 0.8rem);
        }
        th, td {
            font-size: clamp(0.7rem, 3vw, 0.9rem);
        }
        td:first-child {
            font-size: clamp(0.8rem, 4vw, 1rem);
        }
        .bustype-icon {
            width: clamp(8px, 5vw, 28px) !important;
            margin-left: 8px;
        }
        .ticker {
            font-size: clamp(0.6rem, 2vw, 0.8rem);
            line-height: 1.5rem;
        }
        .ticker-wrap {
            height: clamp(12px, 4vw, 24px);
        }
        .time-icon-wrap span {
            min-width: clamp(10px, 5vw, 30px);
        }
    }
</style>
    <!-- Font Awesome for bus icon -->
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/all.css" />
</head>

<body>
    <div class="header">
        <div class="logo">
            <img src="../assets/smrt.png" alt="SMRT Logo">
        </div>
        <div class="title">Choa Chu Kang Interchange</div>
        <div class="clock">
            <div class="clock-time" id="clock-time">20:18</div>
            <div class="clock-date" id="clock-date">Wed, Dec 17</div>
        </div>
    </div>
    <div class="table-responsive">
        <table>
            <colgroup>
                <col class="col-service">
                <col class="col-berth">
                <col class="col-departure1">
                <col class="col-departure2">
            </colgroup>
            <thead>
                <tr class="redbar-head">
                    <th>Services</th>
                    <th>Berth</th>
                    <th>Departure Times</th>
                    <th id="page-indicator">Page 1/1</th>
                </tr>
            </thead>
            <tbody id="bus-table-body">
                <!-- Dynamic rows will be inserted here -->
            </tbody>
        </table>
    </div>

    <div class="ticker-wrap">
        <div class="ticker">
            <span id="ticker-text">
                Welcome to Choa Chu Kang Bus Interchange!&nbsp;&nbsp;&nbsp;Thank you for travelling with SMRT Buses.
            </span>
        </div>
    </div>

    <script>
        // Live clock
        function updateClock() {
            const now = new Date();
            const pad = n => n.toString().padStart(2, '0');
            document.getElementById('clock-time').textContent = pad(now.getHours()) + ':' + pad(now.getMinutes());
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            document.getElementById('clock-date').textContent =
                days[now.getDay()] + ', ' + months[now.getMonth()] + ' ' + now.getDate();
        }
        setInterval(updateClock, 1000);
        updateClock();

        let allServices = [];
        let currentPage = 1;
        const pageSize = 6;
        let pageInterval = null;

        let berthMap = {};
        let serviceOrder = [];

        async function fetchBerthMap() {
            try {
                const response = await fetch('berth-allocation-cck.json');
                const data = await response.json();
                berthMap = data;
                serviceOrder = Array.isArray(data.order) ? data.order : [];
            } catch (err) {
                console.error('Failed to fetch berth allocation', err);
                berthMap = {};
                serviceOrder = [];
            }
        }

        async function fetchBusData() {
            try {
                const response = await fetch('https://bat-lta-9eb7bbf231a2.herokuapp.com/bus-arrivals?BusStopCode=44009');
                const data = await response.json();
                let services = [];
                if (Array.isArray(data)) {
                    services = data;
                } else if (Array.isArray(data.Services)) {
                    services = data.Services;
                } else if (Array.isArray(data.services)) {
                    services = data.services;
                } else if (Array.isArray(data.result)) {
                    services = data.result;
                } else {
                    for (const key in data) {
                        if (Array.isArray(data[key])) {
                            services = data[key];
                            break;
                        }
                    }
                }

                // Custom sort if order is defined
                if (serviceOrder.length) {
                    services.sort((a, b) => {
                        const aIdx = serviceOrder.indexOf(a.ServiceNo || a.service || "");
                        const bIdx = serviceOrder.indexOf(b.ServiceNo || b.service || "");
                        if (aIdx === -1 && bIdx === -1) return 0;
                        if (aIdx === -1) return 1;
                        if (bIdx === -1) return -1;
                        return aIdx - bIdx;
                    });
                }

                allServices = services;
                // currentPage = 1;
                renderTable();
                startPageLoop();
            } catch (err) {
                console.error('Failed to fetch bus data', err);
                document.getElementById('bus-table-body').innerHTML = '<tr><td colspan="4">Unable to load data</td></tr>';
                document.getElementById('page-indicator').textContent = 'Page 1/1';
            }
        }




  function renderTable() {
    const tbody = document.getElementById('bus-table-body');
    tbody.innerHTML = '';
    if (!allServices.length) {
        tbody.innerHTML = '<tr><td colspan="4">No bus data available</td></tr>';
        document.getElementById('page-indicator').textContent = 'Page 1/1';
        return;
    }

    // --- Step 1: Render all rows offscreen to measure how many fit ---
    // Create a fragment to avoid flicker
    const fragment = document.createDocumentFragment();
    allServices.forEach(bus => {
        const service = bus.ServiceNo || bus.service || '';
        const berth = berthMap[service] || bus.Berth || bus.berth || '';
        let next = bus.NextBus?.EstimatedArrival || bus.next || '';
        let next2 = bus.NextBus2?.EstimatedArrival || bus.next2 || '';
        function formatTime(val) {
            if (!val) return '';
            if (val === 'Arr') return 'Arr';
            if (val.length > 5 && val.includes('T')) {
                const d = new Date(val);
                if (isNaN(d)) return '';
                const now = new Date();
                const diff = Math.round((d - now) / 60000);
                if (diff <= 0) return 'Arr';
                const h = d.getHours().toString().padStart(2, '0');
                const m = d.getMinutes().toString().padStart(2, '0');
                return `${h}:${m}`;
            }
            return val;
        }
        next = next ? formatTime(next) : '';
        next2 = next2 ? formatTime(next2) : '';
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${service}</td>
            <td>${berth}</td>
            <td>
                <span class="time-icon-wrap">
                    <span>${next ? next : ''}</span>
                    ${bus.NextBus?.Type ? `<img src="../assets/${bus.NextBus.Type.toLowerCase()}-mono.png" alt="${bus.NextBus.Type}" class="img-fluid bustype-icon" style="width: 80px;">` : ''}
                </span>
            </td>
            <td>
                <span class="time-icon-wrap">
                    <span>${next2 ? next2 : ''}</span>
                    ${bus.NextBus2?.Type ? `<img src="../assets/${bus.NextBus2.Type.toLowerCase()}-mono.png" alt="${bus.NextBus2.Type}" class="img-fluid bustype-icon" style="width: 80px;">` : ''}
                </span>
            </td>
        `;
        fragment.appendChild(row);
    });
    // Add to DOM but keep hidden for measurement
    tbody.appendChild(fragment);
    tbody.style.visibility = 'hidden';

    // --- Step 2: Measure how many rows fit before the ticker ---
    const ticker = document.querySelector('.ticker-wrap');
    const tickerRect = ticker.getBoundingClientRect();
    const rows = Array.from(tbody.querySelectorAll('tr'));
    let maxRows = rows.length;
    for (let i = 0; i < rows.length; i++) {
        const rowRect = rows[i].getBoundingClientRect();
        if (rowRect.bottom > tickerRect.top) {
            maxRows = i;
            break;
        }
    }
    // Fallback if none fit
    if (maxRows < 1) maxRows = 1;
    window.dynamicPageSize = maxRows;

    // --- Step 3: Render only the rows for the current page ---
    const totalPages = Math.max(1, Math.ceil(allServices.length / window.dynamicPageSize));
    if (currentPage > totalPages) currentPage = 1;
    if (currentPage < 1) currentPage = 1;
    const start = (currentPage - 1) * window.dynamicPageSize;
    const end = start + window.dynamicPageSize;
    tbody.innerHTML = '';
    for (let i = start; i < end && i < allServices.length; i++) {
        const bus = allServices[i];
        const service = bus.ServiceNo || bus.service || '';
        const berth = berthMap[service] || bus.Berth || bus.berth || '';
        let next = bus.NextBus?.EstimatedArrival || bus.next || '';
        let next2 = bus.NextBus2?.EstimatedArrival || bus.next2 || '';
        function formatTime(val) {
            if (!val) return '';
            if (val === 'Arr') return 'Arr';
            if (val.length > 5 && val.includes('T')) {
                const d = new Date(val);
                if (isNaN(d)) return '';
                const now = new Date();
                const diff = Math.round((d - now) / 60000);
                if (diff <= 0) return 'Arr';
                const h = d.getHours().toString().padStart(2, '0');
                const m = d.getMinutes().toString().padStart(2, '0');
                return `${h}:${m}`;
            }
            return val;
        }
        next = next ? formatTime(next) : '';
        next2 = next2 ? formatTime(next2) : '';
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${service}</td>
            <td>${berth}</td>
            <td>
                <span class="time-icon-wrap">
                    <span>${next ? next : ''}</span>
                    ${bus.NextBus?.Type ? `<img src="../assets/${bus.NextBus.Type.toLowerCase()}-mono.png" alt="${bus.NextBus.Type}" class="img-fluid bustype-icon" style="width: 80px;">` : ''}
                </span>
            </td>
            <td>
                <span class="time-icon-wrap">
                    <span>${next2 ? next2 : ''}</span>
                    ${bus.NextBus2?.Type ? `<img src="../assets/${bus.NextBus2.Type.toLowerCase()}-mono.png" alt="${bus.NextBus2.Type}" class="img-fluid bustype-icon" style="width: 80px;">` : ''}
                </span>
            </td>
        `;
        tbody.appendChild(row);
    }
    tbody.style.visibility = '';

    // --- Step 4: Update page indicator ---
    document.getElementById('page-indicator').textContent = `Page ${currentPage}/${totalPages}`;
}

// Patch startPageLoop to use dynamicPageSize if set
function startPageLoop() {
    if (pageInterval) clearInterval(pageInterval);
    pageInterval = setInterval(() => {
        const dynamicSize = window.dynamicPageSize || pageSize;
        const totalPages = Math.ceil(allServices.length / dynamicSize) || 1;
        currentPage = currentPage >= totalPages ? 1 : currentPage + 1;
        renderTable();
    }, 6000);
}

        async function init() {
            await fetchBerthMap();
            await fetchBusData();
            setInterval(fetchBusData, 30000);
        }
        init();
    </script>
</body>

</html>